<!DOCTYPE html>
<meta charset="utf-8">
<style>

.background {
  fill: none;
  pointer-events: all;
}

.feature {
  fill: #ccc;
  cursor: pointer;
}

.feature.active {
  fill: orange;
}

.mesh {
  fill: none;
  stroke: #fff;
  stroke-linecap: round;
  stroke-linejoin: round;
}

</style>
<body onload="">
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
<div id="info"><h1 id="name"></h1><h2 id="title"></h2></div>

<script>
  name_id_map = {};
  id_name_map = {};
  code_id_map = {};
  id_code_map = {};
  us_total = {};
  by_year = {};
  by_state = {};
  var interval = 1500;
  var animate = true;
  var numerator = "Total";
  var denominator = "Population";
  var allTime = true;
  var minYear = 1990
  var maxYear = 2014
  d3.tsv("https://s3-us-west-2.amazonaws.com/vida-public/geo/us-state-names.tsv", function(error, names) {
  
	  for (var i = 0; i < names.length; i++) {
		name_id_map[names[i].name] = names[i].id;
		id_name_map[names[i].id] = names[i].name;
		
		code_id_map[names[i].code] = names[i].id;
		id_code_map[names[i].id] = names[i].code;
	  }
	});
  
	var width = 1400,
		height = 750,
		active = d3.select(null);

	var projection = d3.geo.albersUsa()
		.scale(1000)
		.translate([width / 2, height / 2]);

	var path = d3.geo.path()
		.projection(projection);
	var controls = d3.select("body").append("div").attr("class","control_div").attr("id","control_div")
	var control_table = controls.append("table").attr("class","control_table").attr("id","control_table");
	var title_row = control_table.append("tr")
		title_row.append("td").text("Numerator")
		title_row.append("td").text("Denominator")
		

	var svg = d3.select("body").append("svg")
		.attr("width", width)
		.attr("height", height);
		
	var num_options = [
		"Coal",
		"GDP",
		"Geothermal",
		"Hydroelectric Conventional",
		"Natural Gas",
		"Nuclear",
		"Other",
		"Other Gases",
		"Petroleum",
		"Population",
		"Pumped Storage",
		"Solar Thermal and Photovoltaic",
		"Total Energy",
		"Wind",
		'Wood Based Fuels and Biomass',
		'Fossil Fuels Total',
		'Clean Renewables Total'
		]

	var den_options = [
		"GDP",
		"Population"
		]
		
	var updateNumerator = function() {var sel = document.getElementById('num_sel');  numerator = sel.options[sel.selectedIndex].value; };
	var updateDenominator = function() {var sel = document.getElementById('den_sel'); denominator = sel.options[sel.selectedIndex].value; };
	var updateRefBasis = function() {
					var allTimeBasis = true;
					var sel = document.getElementById('basis_sel'); 
					if(sel.options[sel.selectedIndex].value=="All Time") allTimeBasis = true; 
					else allTimeBasis = false;
					console.log("AllTimeBasis: " + allTimeBasis);
					allTime =allTimeBasis;
					return allTimeBasis; 
				}
	var updateSpeed = function() {
		var sel = document.getElementById('speed_sel'); 
		
		if(sel.options[sel.selectedIndex].value=="Low") interval = 300; 
		if(sel.options[sel.selectedIndex].value=="Med") interval = 1000; 
		if(sel.options[sel.selectedIndex].value=="High") interval = 2000; 
		if(sel.options[sel.selectedIndex].value=="Stop") interval = 10000000;
		};

	var control_row = control_table.append("tr");
	var selectNum = control_row.append("td").append("select");
		selectNum.attr("id","num_sel");
		selectNum.selectAll("option")
			.data(num_options)
			.enter()
			.append("option").property('selected', function(d) { if(d=='Total Energy') return 'selected'; else return '' })
			.text(function(d) { return d; });
		selectNum.on("change",updateNumerator);
		
	var selectDen = control_row.append("td").append("select");
		selectDen.attr("id","den_sel");
		selectDen.selectAll("option")
			.data(den_options)
			.enter()
			.append("option").property('selected', function(d) { if(d=='GDP') return 'selected'; else return '' })
			.text(function(d) { return d; });
		selectDen.on("change",updateDenominator);
		
	var button_row = control_table.append("tr");
	var buttons_col = button_row.append("td");
	var buttons_div = buttons_col.append("div").style("float","left");
//	var speedDiv = button_row.append("td").append("div");
//	     speedDiv.attr("class","right-justify").text("Speed");
	var startButton = buttons_col.append("button");
		startButton.text("Start");
		startButton.on("click", function() { animate = true;} );
	var stopButton = buttons_col.append("button");
		stopButton.text("Stop");
		stopButton.on('click', function() {animate = false;});
	var wordzDiv = buttons_col.append("div").style("float","right");
		wordzDiv.text("Reference Basis: ")
	
	var menuCol = button_row.append("td")
	var basisSelect = menuCol.append("select")
		basisSelect.attr("id","basis_sel");
		basisSelect.append("option").text("Same Year");
		basisSelect.append("option").property('selected','selected').text("All Time");
		basisSelect.on('click', updateRefBasis);
		
		
		
	//var selectSpeedTd = button_row.append("td")
	
/*		var selectSpeed = speedDiv.append("select").on("change",updateSpeed);
		selectSpeed.attr("id","speed_sel");
		selectSpeed.append("option").text("Med").property('selected','selected');
		selectSpeed.append("option").text("Low");
		selectSpeed.append("option").text("High");
	*/	
	
	svg.append("rect")
		.attr("class", "background")
		.attr("width", width)
		.attr("height", height)
		.on("click", reset);

	var g = svg.append("g")
		.style("stroke-width", "1.5px");

			
	d3.json("https://s3-us-west-2.amazonaws.com/vida-public/geo/us.json", function(error, us) {
	  if (error) throw error;
	  
	g.selectAll("path")
		  .data(topojson.feature(us, us.objects.states).features, function(d) { return id_code_map[d.id];})
		  .enter()
		  .append("path")
		  .attr("d", path)
		  .attr("class", "feature")
		  .attr("id", function(d) { return id_code_map[d.id];})
		  .on('click',clicked)
		  .on('mouseover', function(d){
				var code = id_code_map[d.id];
				console.log(d);
				return true;
			});

	 //debugger;
	  g.append("path")
		  .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
		  .attr("class", "mesh")
		  .attr("d", path);
	
	  console.log("Loading Data.")
	  
	  d3.csv("./annual_generation_state_clean3.csv", function(d) {
		//Add aggregations here.
		d['Clean Renewables Total'] = (+d['Hydroelectric Conventional']) + (+d['Solar Thermal and Photovoltaic']) + (+d['Geothermal']) + (+d['Wind']);
		d['Fossil Fuels Total'] = (+d['Natural Gas']) + (+d['Coal']) + (+d['Petroleum']);
		d['Wood Based Fuels and Biomass'] = (+d['Other Biomass']) + (+d['Wood and Wood Derived Fuels']);
		d['Total Energy'] = d['Total'];
		
		return d;
	  }, plot_points);

	});

	function getAllTimeUSAvg(valueName) {
		var usData;
		var usSum=0;
		for (state in by_state) if(by_state[state].key.toUpperCase()=='US-TOTAL') usData = by_state[state];
		for (year in usData.values) {
			usSum += (+usData.values[year][valueName]);
			}
		return usSum/usData.values.length;
	}

	function plot_points(energy_data) {
		//alert(d.length);
		
		by_year = d3.nest()
			.key(function(d) { return d.Year; })
			.entries(energy_data);

		by_state = d3.nest()
			.key(function(d) { return d.State; })
			.entries(energy_data);
				debugger;
		var usAvgPop = getAllTimeUSAvg('Population');
		var usAvgCoal = getAllTimeUSAvg('Coal');
		[minYear,maxYear] = d3.extent(by_year, function(d) { return +d["key"]} );
	
		//for(year in usData.values) usAvgPop += +usData.values[year]['Population'];
		startTimerLoop();
	}

	function update_year(leaf,year) {
		//debugger;
		console.log("year: " + year);
		
		for (l in leaf) {
			if(leaf[l].State.toUpperCase()=='US-TOTAL') {
				us_total = leaf[l]
			}
		}

		var title = year;
		
		var ratio_extent = d3.extent(leaf, function(d) { return (+d[numerator]/+d[denominator]) });

		
		var ref_factor = +us_total[numerator]/+us_total[denominator];
		var titleStr = year + " - US "
		if(allTime==true){
			
			
			ref_factor = getAllTimeUSAvg(numerator)/getAllTimeUSAvg(denominator);
			titleStr = minYear + " - " + maxYear + " US Avg "
		}
		document.getElementById('name').innerHTML=year;
		document.getElementById('title').innerHTML= titleStr + numerator + " / " + denominator + " = " + ref_factor;
		
		for (state in leaf) {

			var stateYearData = leaf[state]
			var stateName = stateYearData["State"];

			g.select("#" + stateName).datum(stateYearData);
			update_state(stateName,numerator,denominator,ref_factor,ratio_extent);
			
		}
		
	}

	
	function update_state(state,numerator,denominator,ref_factor,extent) {
		
		//Scale the color based on relative ratio value to reference factor.
		var ramp=d3.scale.linear().domain(extent).range(["yellow","blue"])
		g.select("#" + state).style("fill", function(d){  return ramp(+d[numerator]/+d[denominator]);  })

	}

	function startTimerLoop() {

		
		updateNumerator();
		updateDenominator();
		var i=0;

		debugger;
		console.log("Starting timer function.");
		var upd = function() {
			if(animate==true) {
				if(i>=by_year.length) i=0;
				update_year(by_year[i].values,by_year[i].key);
				i++;
			}
		}

		console.log("Starting timer.");
		d3.interval(upd,interval);
	}

	function clicked(d) {

	  if (active.node() === this) return reset();
	  active.classed("active", false);
	  active = d3.select(this).classed("active", true);
	  
	 
	  var bounds = path.bounds(d),
		  dx = bounds[1][0] - bounds[0][0],
		  dy = bounds[1][1] - bounds[0][1],
		  x = (bounds[0][0] + bounds[1][0]) / 2,
		  y = (bounds[0][1] + bounds[1][1]) / 2,
		  scale = .9 / Math.max(dx / width, dy / height);
	  
	  translate = [width / 2 - scale * x, height / 2 - scale * y];
		  //alert("Dx: " + dx + " Dy: " + dy + " x: " + x + " y: " + y);

	  g.transition()
		  .duration(750)
		  .style("stroke-width", 1.5 / scale + "px")
		  .attr("transform", "translate(" + translate + ")scale(" + scale + ")");
	}

	function reset() {
	  active.classed("active", false);
	  active = d3.select(null);

	  g.transition()
		  .duration(750)
		  .style("stroke-width", "1.5px")
		  .attr("transform", "");
	}

</script>
</body>
</html>


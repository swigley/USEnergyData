<!DOCTYPE html>
<meta charset="utf-8">
<style>

.background {
  fill: none;
  pointer-events: all;
}

.feature {
  fill: #ccc;
  cursor: pointer;
}

.feature.active {
  fill: orange;
}

.mesh {
  fill: none;
  stroke: #fff;
  stroke-linecap: round;
  stroke-linejoin: round;
}

div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: 140px;					
    height: 85px;					
    padding: 2px;				
    font: 12px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
}

</style>
<body onload="">
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
<div id="info"><h1 id="name"></h1><h3 id="title"></h3></div>

<script>
  name_id_map = {};
  id_name_map = {};
  code_id_map = {};
  id_code_map = {};
  us_total = {};
  by_year = {};
  by_state = {};
  var interval = 1500;
  var animate = true;
  var numerator = "Total";
  var denominator = "Population";
  var allTime = true;
  var minYear = 1990
  var maxYear = 2014
  var allTimeRef = 0;
  var lowColor = "Orange";
  var highColor = "SteelBlue";
  d3.tsv("https://s3-us-west-2.amazonaws.com/vida-public/geo/us-state-names.tsv", function(error, names) {
  
	  for (var i = 0; i < names.length; i++) {
		name_id_map[names[i].name] = names[i].id;
		id_name_map[names[i].id] = names[i].name;
		
		code_id_map[names[i].code] = names[i].id;
		id_code_map[names[i].id] = names[i].code;
	  }
	});
  
	var width = 1400,
		height = 750,
		active = d3.select(null);

	var projection = d3.geo.albersUsa()
		.scale(1000)
		.translate([width / 2, height / 2]);

	var path = d3.geo.path()
		.projection(projection);
	var controls = d3.select("body").append("div").attr("class","control_div").attr("id","control_div")
	var control_table = controls.append("table").attr("class","control_table").attr("id","control_table");
	var title_row = control_table.append("tr")
		title_row.append("td").text("Numerator")
		title_row.append("td").text("Denominator")
		title_row.append("td").text("Colors")
		

	var svg = d3.select("body").append("svg")
		.attr("width", width)
		.attr("height", height);
		
	var num_options = [
		"Coal",
		"GDP",
		"Geothermal",
		"Hydroelectric Conventional",
		"Natural Gas",
		"Nuclear",
		"Other",
		"Other Gases",
		"Petroleum",
		"Population",
		"Pumped Storage",
		"Solar Thermal and Photovoltaic",
		"Total Energy",
		"Wind",
		'Wood Based Fuels and Biomass',
		'Fossil Fuels Total',
		'Clean Renewables Total'
		]

	var den_options = [
		"GDP",
		"Population"
		]
		
	var color_options = [
	"Orange",
	"Blue",
	"Red",
	"SteelBlue",
	"Yellow",
	"Green",
	"Magenta",
	"Cyan"
	]
		
	var updateNumerator = function() {
			var sel = document.getElementById('num_sel');  
			numerator = sel.options[sel.selectedIndex].value; 
			allTimeRef = getAllTimeUSAvg(numerator)/getAllTimeUSAvg(denominator);
		};
	var updateDenominator = function() {
			var sel = document.getElementById('den_sel'); 
			denominator = sel.options[sel.selectedIndex].value; 
			allTimeRef = getAllTimeUSAvg(numerator)/getAllTimeUSAvg(denominator);
		};
	var updateRefBasis = function() {
					var allTimeBasis = true;
					var sel = document.getElementById('basis_sel'); 
					if(sel.options[sel.selectedIndex].value=="All Time") {
						allTimeBasis = true; 
						allTimeRef = getAllTimeUSAvg(numerator)/getAllTimeUSAvg(denominator);
					} else allTimeBasis = false;
					console.log("AllTimeBasis: " + allTimeBasis);
					allTime =allTimeBasis;
					return allTimeBasis; 
				}
	var updateLowColor = function() {
		var sel = document.getElementById('lowColor_sel'); 
		lowColor = sel.options[sel.selectedIndex].value
		};
		
	var updateHighColor = function() {
		var sel = document.getElementById('highColor_sel'); 
		highColor = sel.options[sel.selectedIndex].value
		};

	var control_row = control_table.append("tr");
	var selectNum = control_row.append("td").append("select");
		selectNum.attr("id","num_sel");
		selectNum.selectAll("option")
			.data(num_options)
			.enter()
			.append("option").property('selected', function(d) { if(d=='Total Energy') return 'selected'; else return '' })
			.text(function(d) { return d; });
		selectNum.on("change",updateNumerator);
		
	var selectDen = control_row.append("td").append("select");
		selectDen.attr("id","den_sel");
		selectDen.selectAll("option")
			.data(den_options)
			.enter()
			.append("option").property('selected', function(d) { if(d=='GDP') return 'selected'; else return '' })
			.text(function(d) { return d; });
		selectDen.on("change",updateDenominator);
		
	var button_row = control_table.append("tr");
	var buttons_col = button_row.append("td");
	var buttons_div = buttons_col.append("div").style("float","left");
//	var speedDiv = button_row.append("td").append("div");
//	     speedDiv.attr("class","right-justify").text("Speed");
	var startButton = buttons_col.append("button");
		startButton.text("Start");
		startButton.on("mouseover", function(d) {console.log("mouseover start. ")});
		startButton.on("click", function() { animate = true;} );
	var stopButton = buttons_col.append("button");
		stopButton.text("Stop");
		stopButton.on('click', function() {animate = false;});
	var wordzDiv = buttons_col.append("div").style("float","right");
		wordzDiv.text("Reference Basis: ")
	
	var menuCol = button_row.append("td")
	var basisSelect = menuCol.append("select")
		basisSelect.attr("id","basis_sel");
		basisSelect.append("option").text("Same Year");
		basisSelect.append("option").property('selected','selected').text("All Time");
		basisSelect.on('click', updateRefBasis);
		
	var tooltip = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);
		
	var selectLowColorTd = control_row.append("td")
	var selectLowColor = selectLowColorTd.append("select")
		selectLowColor.on("change",updateLowColor);
		selectLowColor.attr("id","lowColor_sel");
		selectLowColor.selectAll("option")
			.data(color_options)
			.enter()
			.append("option").property('selected', function(d) { if(d=='Red') return 'selected'; else return '' })
			.text(function(d) { return d; });
		
		
		
	var selectHighColorTd = button_row.append("td")
	
		var selectHighColor = selectHighColorTd.append("select")
		selectHighColor.on("change",updateHighColor);
		selectHighColor.attr("id","highColor_sel");
		selectHighColor.selectAll("option")
			.data(color_options)
			.enter()
			.append("option").property('selected', function(d) { if(d=='Green') return 'selected'; else return '' })
			.text(function(d) { return d; });
		
	
	svg.append("rect")
		.attr("class", "background")
		.attr("width", width)
		.attr("height", height)
		.on("click", reset);

	var g = svg.append("g")
		.style("stroke-width", "1.5px");

			
	d3.json("https://s3-us-west-2.amazonaws.com/vida-public/geo/us.json", function(error, us) {
	  if (error) throw error;
	  

	  
	g.selectAll("path")
		  .data(topojson.feature(us, us.objects.states).features, function(d) { return id_code_map[d.id];})
		  .enter()
		  .append('path')
		  .attr('d', path)
		  .attr('class', 'feature')
		  .attr('id', function(d) { return id_code_map[d.id];})
		  .on('click',clicked);

	 //debugger;
	  g.append("path")
		  .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
		  .attr("class", "mesh")
		  .attr("d", path);
	
	  console.log("Loading Data.")
	  
	  d3.csv("./annual_generation_state_clean3.csv", function(d) {
		//Add aggregations here.
		d['Clean Renewables Total'] = (+d['Hydroelectric Conventional']) + (+d['Solar Thermal and Photovoltaic']) + (+d['Geothermal']) + (+d['Wind']);
		d['Fossil Fuels Total'] = (+d['Natural Gas']) + (+d['Coal']) + (+d['Petroleum']);
		d['Wood Based Fuels and Biomass'] = (+d['Other Biomass']) + (+d['Wood and Wood Derived Fuels']);
		d['Total Energy'] = d['Total'];
		
		return d;
	  }, plot_points);

	});

	function getAllTimeUSAvg(valueName) {
		var usData;
		var usSum=0;
		for (state in by_state) if(by_state[state].key.toUpperCase()=='US-TOTAL') usData = by_state[state];
		for (year in usData.values) {
			usSum += (+usData.values[year][valueName]);
			}
		return usSum/usData.values.length;
	}

	function plot_points(energy_data) {
		//alert(d.length);
		
		by_year = d3.nest()
			.key(function(d) { return d.Year; })
			.entries(energy_data);

		by_state = d3.nest()
			.key(function(d) { return d.State; })
			.entries(energy_data);
			
		var usAvgPop = getAllTimeUSAvg('Population');
		var usAvgCoal = getAllTimeUSAvg('Coal');
		[minYear,maxYear] = d3.extent(by_year, function(d) { return +d["key"]} );
		
	
		//for(year in usData.values) usAvgPop += +usData.values[year]['Population'];
		startTimerLoop();
	}

	function update_year(leaf,year) {
		//debugger;
		//console.log("year: " + year);
		
		for (l in leaf) {
			if(leaf[l].State.toUpperCase()=='US-TOTAL') {
				us_total = leaf[l]
			}
		}

		var title = year;
		
		var ratio_extent = d3.extent(leaf, function(d) { 
				return (+d[numerator]/+d[denominator]) 
			});

		//Initialize values based on the assumption we're using a per-year ref_factor.
		var ref_factor = +us_total[numerator]/+us_total[denominator];
		var titleStr = year + " - US "
		//Overwrite if allTime selection is selected.
		if(allTime==true){
			ref_factor = allTimeRef;
			titleStr = minYear + " - " + maxYear + " US Avg "
		}
		document.getElementById('name').innerHTML=year;
		document.getElementById('title').innerHTML= titleStr + numerator + " / " + denominator + " = " + ref_factor;
		
		for (state in leaf) {

			var stateYearData = leaf[state]
			var stateName = stateYearData["State"];
			
			//Get existing state topo data, and append energy data, then replace.
			//debugger;
			if(stateName!="US-TOTAL") {
				var stateData = g.select("#" + stateName).datum();
				stateData.energyData = stateYearData;
				//debugger;
				g.select("#" + stateName).datum(stateData);
				update_state(stateName,numerator,denominator,ref_factor,ratio_extent);
			}
		}
		
	}

	
	function update_state(state,numerator,denominator,ref_factor,extent) {
		
		//Scale the color based on relative ratio value to reference factor.
		var ramp=d3.scale.linear().domain(extent).range([lowColor,highColor])
		var state = g.select("#"+ state);
		state.style("fill", function(d){  return ramp(+d.energyData[numerator]/+d.energyData[denominator]);  });
		state.on("mouseover", function(d) {		
            tooltip.transition()		
                .duration(200)		
                .style("opacity", .9);		
            tooltip.html(d.energyData["Year"] + " " + d.energyData["State"] + " " + numerator + " / " + denominator + ": " + (+d.energyData[numerator]/+d.energyData[denominator]).toFixed(2) +  "<br/>")	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");	
            })
			.on("mouseout", function(d) {		
            tooltip.transition()		
                .duration(500)		
                .style("opacity", 0);	
        });

		

	}

	function startTimerLoop(allTimeRef) {

		
		updateNumerator();
		updateDenominator();
		var i=0;

		//debugger;
		console.log("Starting timer function.");
		var upd = function() {
			if(animate==true) {
				if(i>=by_year.length) i=0;
				//debugger;
				update_year(by_year[i].values,by_year[i].key,allTimeRef);
				i++;
			}
		}

		console.log("Starting timer.");
		d3.interval(upd,interval);
	}

	function clicked(d) {
		console.log("clicked: " + d);
		//debugger;
	  if (active.node() === this) return reset();
	  active.classed("active", false);
	  active = d3.select(this).classed("active", true);
	  
	 
	  var bounds = path.bounds(d),
		  dx = bounds[1][0] - bounds[0][0],
		  dy = bounds[1][1] - bounds[0][1],
		  x = (bounds[0][0] + bounds[1][0]) / 2,
		  y = (bounds[0][1] + bounds[1][1]) / 2,
		  scale = .9 / Math.max(dx / width, dy / height);
	  
	  translate = [width / 2 - scale * x, height / 2 - scale * y];
		  console.log("Dx: " + dx + " Dy: " + dy + " x: " + x + " y: " + y + " scale: " + scale + " translate: " + translate + " bounds: " + bounds);
		
	debugger;
	  g.transition()
		  .duration(750)
		  .style("stroke-width", 1.5 / scale + "px")
		  .attr("transform", "translate(" + translate + ")scale(" + scale + ")");
	}

	function reset() {
	  active.classed("active", false);
	  active = d3.select(null);

	  g.transition()
		  .duration(750)
		  .style("stroke-width", "1.5px")
		  .attr("transform", "");
	}

</script>
</body>
</html>

